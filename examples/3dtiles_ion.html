<!DOCTYPE html>
<html>
    <head>
        <title>Itowns - 3d-tiles from Cesium ion example</title>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/LoadingScreen.css">

        <style type="text/css">
            #description {
                z-index: 2;
                left: 10px;
                width: 30%;
            }
        </style>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.6/dat.gui.min.js"></script>
    </head>
    <body>
        <div id="description">
            <p><b>This example displays a dataset representing extruded OSM buildings from Cesium ion 
                with Cesium default access token. Zoom to any place in the world to see the buildings. <br>
                Buildings may appear to "fly" above the ground in some places, this is due to the combination 
                of precision errors of this dataset and of the 3D terrain we use in this example. </b>
            </p>
        </div>
        <div id="attribution"></div>
        <div id="viewerDiv"></div>

        <!-- Import iTowns source code -->
        <script src="../dist/itowns.js"></script>
        <!-- Import iTowns LoadingScreen plugin -->
        <script src="js/GUI/LoadingScreen.js"></script>

        <script type="text/javascript">

            // ---------- CREATE A GlobeView FOR SUPPORTING DATA VISUALIZATION : ----------

            // Define camera initial position
            const placement = {
                coord: new itowns.Coordinates('EPSG:4326', 2.351323, 48.856712),
                range: 25000000,
            }
            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            var viewerDiv = document.getElementById('viewerDiv');

            // Create a GlobeView
            var viewOptions = {
                diffuse: new itowns.THREE.Color(0xa0d5fc)
            };
            var view = new itowns.GlobeView(viewerDiv, placement, viewOptions);
            
            // Setup loading screen
            setupLoadingScreen(viewerDiv, view);

            // ---------- ADD A BASEMAP: ----------

            // Add one imagery layer to the scene. This layer's properties are defined in a json file, but it could be
            // defined as a plain js object. See `Layer` documentation for more info.
            itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then(function _(config) {
                config.source = new itowns.WMTSSource(config.source);
                view.addLayer(
                    new itowns.ColorLayer('Ortho', config),
                ).then(debugMenu.addLayerGUI.bind(debugMenu));
            });

            function createWMTSSourceFromConfig(config) {
                config.source = new itowns.WMTSSource(config.source);
                return config;
            }

            function addColorLayerFromConfig(config) {
                var layer = new itowns.ColorLayer(config.id, config);
                view.addLayer(layer).then(menuGlobe.addLayerGUI.bind(menuGlobe));
            }

            itowns.Fetcher.json('./layers/JSONLayers/Administrative.json').then(createWMTSSourceFromConfig).then(addColorLayerFromConfig);

            // ---------- ADD DIGITAL ELEVATION MODELS : ----------

             // Add two elevation layers, each with a different level of detail. Here again, each layer's properties are
            // defined in a json file.
            // function addElevationLayerFromConfig(config) {
            //     config.source = new itowns.WMTSSource(config.source);
            //     view.addLayer(
            //         new itowns.ElevationLayer(config.id, config),
            //     );
            // }
            // itowns.Fetcher.json('./layers/JSONLayers/WORLD_DTM.json').then(addElevationLayerFromConfig);
            // itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT_HIGHRES.json').then(addElevationLayerFromConfig);

            var terrainSource = new itowns.WMTSSource({
                "url": "http://10.1.40.224/rok4/wmts?",
                "crs": "EPSG:4326",
                "format": "image/x-bil;bits=32",
                "attribution" : {
                    "name":"IGN",
                    "url":"http://www.ign.fr/"
                },
                "name": "TERRAIN",
                "tileMatrixSet": "WGS84G",
                "tileMatrixSetLimits": {
                    "0": {
                    "minTileRow": 0,
                    "maxTileRow": 0,
                    "minTileCol": 0,
                    "maxTileCol": 1
                    },
                    "1": {
                        "minTileRow": 0,
                        "maxTileRow": 1,
                        "minTileCol": 1,
                        "maxTileCol": 3
                    },
                    "2": {
                        "minTileRow": 0,
                        "maxTileRow": 2,
                        "minTileCol": 2,
                        "maxTileCol": 7
                    },
                    "3": {
                        "minTileRow": 1,
                        "maxTileRow": 5,
                        "minTileCol": 5,
                        "maxTileCol": 15
                    },
                    "4": {
                        "minTileRow": 3,
                        "maxTileRow": 10,
                        "minTileCol": 10,
                        "maxTileCol": 30
                    },
                    "5": {
                        "minTileRow": 6,
                        "maxTileRow": 20,
                        "minTileCol": 20,
                        "maxTileCol": 61
                    },
                    "6": {
                        "minTileRow": 13,
                        "maxTileRow": 40,
                        "minTileCol": 41,
                        "maxTileCol": 123
                    },
                    "7": {
                        "minTileRow": 27,
                        "maxTileRow": 80,
                        "minTileCol": 82,
                        "maxTileCol": 247
                    },
                    "8": {
                        "minTileRow": 54,
                        "maxTileRow": 160,
                        "minTileCol": 164,
                        "maxTileCol": 494
                    },
                    "9": {
                        "minTileRow": 108,
                        "maxTileRow": 321,
                        "minTileCol": 329,
                        "maxTileCol": 989
                    },
                    "10": {
                        "minTileRow": 216,
                        "maxTileRow": 642,
                        "minTileCol": 659,
                        "maxTileCol": 1979
                    },
                    "11": {
                        "minTileRow": 432,
                        "maxTileRow": 1285,
                        "minTileCol": 1319,
                        "maxTileCol": 3959
                    },
                    "12": {
                        "minTileRow": 885,
                        "maxTileRow": 2343,
                        "minTileCol": 3978,
                        "maxTileCol": 5126
                    },
                    "13": {
                        "minTileRow": 1770,
                        "maxTileRow": 4687,
                        "minTileCol": 7957,
                        "maxTileCol": 10253
                    },
                    "14": {
                        "minTileRow": 3540,
                        "maxTileRow": 9375,
                        "minTileCol": 15914,
                        "maxTileCol": 20507
                    }
                }
            });

            var terrainLayer = new itowns.ElevationLayer('mnt-bg', {
                    id: 'mnt-bg',
                    noDataValue : -99999,
                    source: terrainSource
                });
            view.addLayer(terrainLayer);

            // ---------- ADD 3D TILES MODEL FROM CESIUM ION SERVER : ----------

            // Enable draco compression (used by this tileset)
            /*itowns.enableDracoLoader('./libs/draco/');

            // Create a new 3D Tiles batch table hierarchy extension manager and add it to the tileset since this tileset
            // uses this extension
            const extensions = new itowns.C3DTExtensions();
            extensions.registerExtension("3DTILES_batch_table_hierarchy",
                { [itowns.C3DTilesTypes.batchtable]:
                    itowns.C3DTBatchTableHierarchyExtension });
            
            // Create a 3D Tiles layer from Cesium ion server with Cesium default access token and assetId of the 
            // OSM buildings dataset.
            var threeDTilesIonSource = new itowns.C3DTilesIonSource({
                accessToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzOTkxZjY3NS0yNDU4LTQ3MTAtOGQ2NC1lOGI4YmY5ODhhYjQiLCJpZCI6Mzg4OTQsImlhdCI6MTYwNjkyMDkwOH0.aVrPA4xnpbSUlqfJ9RkSWmZtms_hnSRz7m596h1R7ew',
                assetId: 96188
            });
            threeDTilesIonSource.whenReady.then(displayAttributions); // Add attributions returned by cesium ion server
            var threeDTilesIonLayer = new itowns.C3DTilesLayer('3d-tiles-cesium-ion', {
                name: '3D Tiles from Cesium Ion',
                source: threeDTilesIonSource,
                registeredExtensions: extensions,
            }, view);

            itowns.View.prototype.addLayer.call(view, threeDTilesIonLayer);*/

            // Automatically convert cesium html attributions into html node elements and append them to the
            // attributions div
            function displayAttributions() {
                var attribDiv = document.getElementById('attribution');
                for (attrib of threeDTilesIonSource.attribution) {
                    var attribElt = document.createElement('template');
                    attribElt.innerHTML = attrib.html;
                    attribDiv.appendChild(attribElt.content.firstChild);
                }
            }

            // ---------- ADD LIGHTS: ----------
            var ambLight = new itowns.THREE.AmbientLight(0xffffff, 1);
            view.scene.add( ambLight );
        </script>
    </body>
</html>
